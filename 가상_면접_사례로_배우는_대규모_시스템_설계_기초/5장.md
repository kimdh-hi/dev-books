## 5장 안정 해시 설계

수평적 규모 확장성 위해 요청 또는 데이터를 각 서버에 균등하게 나누는 것이 중요하다.
안정해시는 이를 위한 보편적으로 사용되는 기술이다.

### 해시 키 재배치 문제 (rehash)
N개 의 캐시 서버에 부하를 균등하게 나누는 보편적 방법은 해시함수를 사용하는 것이다.
```
hash(key) % N (N == 서버개수)
```

나머지 연산을 사용하는 이 방법은 서버 풀의 크기가 정해진 경우, 데이터 분포가 균등할 때 잘 동작한다.

위 방식(나머지 연산) 의 경우 서버가 추가되거나 줄어드는 경우 문제가 발생할 수 있다. 나머지 연산(서버개수)가 달라지기 때문에 인덱스에 큰 변화가 생길 것이고 이는 `많은 캐시미스`를 초래할 수 있다.


### 안정 해시
안정해시 는 해시 테이블 크기가 조정될 때 평균적으로 `k/n` 개의 키만 재배치하는 해시 기술이다. (k=키의 수, n=슬롯 수)


#### 해시 링
`SHA-1` 의 경우 해시 공간이 `0~2^160-1` 로 알려져 있다.
이 해시 공간을 구부려서 링을 만든다면 해시 링이 된다.

이 링 형태의 해시 공간에 해시함수를 사용해서 서버를 할당한다.
`이 때 사용되는 해시함수는 나머지 연산을 사용하지 않는다.`

링 형태 해시 공간에 서버를 할당했다면 다음으로 키를 할당한다.

키를 통해 서버를 찾을 때에는 시계방향으로 가까운 서버를 찾는다.

서버가 추가/삭제 된다면?
추가/삭제되는 서버를 향하는 키만 재배치가 발생한다.
추가의 경우 시계방향 순회 중 추가된 서버가 먼저 발견된다면 해당 서버로 향할 것이고, 제거의 경우 마찬가자리로 시계방향 순회 중 제거된 서버 이후 서버를 찾아갈 것이다.

해시 링 안정 해시 알고리즘의 문제
서버가 추가,제거되는 상황에서 `파티션의 크기를 균등하게 유지하는 것이 불가능`하다.
```
파티션: 인접한 서버 사이의 해시공간
```

해시 링 형태 해시공간에 4개 서버가 균등한 파티션을 갖고 있을 때 한 개 서버가 제거되면 특정 서버는 다른 서버보다 두 배 많은 해시 공간을 갖게 된다.

#### 가상노드
가상 노드는 실제 노드, 서버를 가리키는 노드로 `하나의 서버 위에는 여러 개의 가상 노드`를 가질 수 있다.<br/>

`한 개 서버가 하나의 파티션만을 가질 때와 달리` 가상 노드를 사용하면 `하나의 서버가 여러 파티션`을 가질 수 있다.

가상 노드의 개수를 늘리면 키의 분포는 점점 균등해진다.<br/>
하지만 가상 노드를 저장할 공간은 더 필요로 한다. 이는 트레이드 오프이다.


### 요약 - 안정해시의 이점
- 서버 추가,삭제 시 재배치되는 키의 수가 최소화된다. (대량의 미스 방지)
- 데이터를 보다 균등하게 분포되므로 수평적 규모 확장성을 달성하기 쉽다.
- 핫스팟 키 문제를 줄인다. 데이터를 각 파티션으로 보다 균등하게 분배하여 특정 파티션으로 데이터가 몰릴 가능성을 줄인다.


여기서 가상 노드를 A 서버의 스케일 아웃된 인스턴스 A-1, A-2 로 생각하면 되는 건가??